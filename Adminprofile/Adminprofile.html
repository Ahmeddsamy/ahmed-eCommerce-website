<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/x-icon" href="../images/logo.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link href="Adminprofile.css" rel="stylesheet" />
  </head>
  <body>
    <!-- HEADER -->
    <nav onscroll="handling()">
      <a href="../main2.html">
        <img src="../images/logo.svg" alt="logo" class="main-page"
      /></a>
      <img src="../images/icons8-cart-96.png" alt="cart" id="cart" />
    </nav>
    <!-- BODY -->
    <!-- Left Nav -->
    <div class="adminContainer">
      <div class="sidebar">
        <div class="ourDashboard">
          <div class="icon">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="dashtxt">Admin Dashboard</div>
        </div>
        <button class="btn cell" id="pending" onclick="showContent('orders')">
          Pending Orders
        </button>
        <button
          class="btn cell wishlist-btn"
          id="categories"
          onclick="showContent('wishlist')"
        >
          CRUD System
        </button>
        <button
          class="btn cell"
          id="products"
          onclick="showContent('profile-info')"
        >
          Order History
        </button>
        <button class="btn btnHome" id="home">Return to Home Page</button>
      </div>
      <!-- Main Container -->
      <div class="adminContent">
        <div class="orders-content active-content">
          <!-- Content for Orders -->
          <h2>Pending Orders</h2>
          <br />
          <br />
          <!-- Add content specific to Orders here -->
          <!-- <div class="orders-cards">
            <div class="order-card-header">
              <div class="order-details">
                Order Placed: <br />10 December 2023
              </div>

              <div class="order-details">Total: <br />$ 116.50</div>
              <div class="order-details">Order Number: <br />123456789</div>
              <button class="accept-btn">Accept</button>
              <button class="reject-btn">Reject</button>
            </div>
            <div class="order-card-body">
              <h3 class="order-details">Order Status: Pending</h3>
              <div class="order-contents">
                <img
                  class="product-img order-details"
                  src="../images/51kzIp0mUnL._AC_SY741_.jpg"
                />
                <div class="order-details">
                  Mens Casual Premium Slim Fit T-Shirts
                </div>
                <div class="order-details">
                  Quantity: <br />
                  2
                </div>
                <div class="order-details">
                  Total Price: <br />
                  $ 109.95
                </div>
              </div>
            </div>
          </div>
          <hr /> -->
        </div>

        <div class="wishlist-content">
          <!-- Content for CRUD -->
          <h2>Products CRUD System</h2>
          <br /><br />
          <!-- Add content specific to CRUD here -->
          <div class="wishlist">
            <form id="productForm">
              <div class="form-group elem3">
                <span>Product Name:</span>
                <input type="text" class="form-field" id="productName" />
              </div>
              <br /><br />
              <div class="form-group elem5">
                <span>Description:</span>
                <textarea class="form-field" id="description"></textarea>
              </div>
              <br /><br />
              <div class="form-group elem1">
                <span>Category:</span>
                <select class="form-field" id="catinp"></select>
                <!-- Updated as a select input -->
              </div>
              <br /><br />
              <div class="form-group elem4">
                <span>Price:</span>
                <input class="form-field" type="number" id="price" />
              </div>
              <br /><br />
              <div class="form-group elem2">
                <span>Quantity:</span>
                <input class="form-field" type="number" id="quantity" />
              </div>
              <br /><br />
              <div class="form-group elem6">
                <span>Image URL:</span>
                <input class="form-field" type="url" id="imgurl" />
              </div>
              <br /><br />
              <div class="form-group elem2">
                <div id="imagesDiv"></div>
              </div>
              <br />
              <div class="controlDiv elem7">
                <button id="addProductBtn">Add Product</button>
              </div>
            </form>
          </div>
          <h2>Categories CRUD System</h2>
          <br /><br />
          <!-- Add content specific to CRUD here -->
          <div class="wishlist">
            <form id="categoryForm">
              <div class="form-group elem3">
                <span>Category ID:</span>
                <input class="form-field" type="Number" id="categoryid" />
              </div>
              <div class="form-group elem4">
                <span>Category:</span>
                <input class="form-field" type="text" id="category" />
              </div>
              <div class="controlDiv elem7">
                <button id="addCategoryBtn">Add Category</button>
              </div>
            </form>
          </div>
        </div>
        <div class="profile-info-content">
          <!-- Content for Profile Info -->
          <h2>All Past Orders</h2>
          <!-- Add content specific to Profile Info here -->
          <div class="profile-content" id="ordersContainer">
            <!-- Orders will be dynamically added here -->
          </div>
        </div>
      </div>
    </div>
    <!-- FOOTER -->
    <footer>
      <p>Copyright&copy; Ecommerce shop 2023. All rights reserved</p>
    </footer>
    <script src="Adminprofile.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCYSCp9ciAbTeM_DYOpOlwRqH33hEfV5pI",
        authDomain: "ecommerce-iti-5e820.firebaseapp.com",
        databaseURL:
          "https://ecommerce-iti-5e820-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ecommerce-iti-5e820",
        storageBucket: "ecommerce-iti-5e820.appspot.com",
        messagingSenderId: "646973727955",
        appId: "1:646973727955:web:871efec421dc8355bf6026",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      import {
        getDatabase,
        ref,
        child,
        get,
        set,
        update,
        remove,
        push,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      const db = getDatabase();

      //////////////////CRUD///////////////////////

      // Function to handle category form submission
      const handleCategoryFormSubmit = (event) => {
        event.preventDefault();

        // Get category form values
        const categoryId = document.getElementById("categoryid").value;
        const category = document.getElementById("category").value;

        // Validate category form data (add your own validation logic as needed)

        // Create a new category object
        const newCategory = {
          categoryId,
          category,
        };

        // Get a reference to the 'categories' node in your Firebase database
        const categoriesRef = ref(db, "categories");

        // Use push function to add the new category
        const newCategoryRef = push(categoriesRef);
        set(newCategoryRef, newCategory);

        // Clear category form fields
        document.getElementById("categoryForm").reset();
      };

      // Attach the category form submission handler to the category form
      const categoryForm = document.getElementById("categoryForm");
      categoryForm.addEventListener("submit", handleCategoryFormSubmit);

      // Function to populate category select input
      const populateCategorySelect = (categories) => {
        const catSelect = document.getElementById("catinp");

        // Clear existing options
        catSelect.innerHTML = "";

        // Add default option
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.text = "Select a Category";
        catSelect.add(defaultOption);

        // Add options based on categories from the database
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.categoryId;
          option.text = category.category;
          catSelect.add(option);
        });
      };

      // Get categories from the database and populate the category select input
      const categoriesRef = ref(db, "categories");
      onValue(categoriesRef, (snapshot) => {
        const categories = [];
        snapshot.forEach((childSnapshot) => {
          const category = childSnapshot.val();
          categories.push(category);
        });

        // Populate the category select input
        populateCategorySelect(categories);
      });
      // Function to handle product form submission
      const handleProductFormSubmit = async (event) => {
        event.preventDefault();

        // Get product form values
        const productName = document.getElementById("productName").value;
        const description = document.getElementById("description").value;
        const category = document.getElementById("catinp").value;
        const price = document.getElementById("price").value;
        const quantity = document.getElementById("quantity").value;
        const imageUrl = document.getElementById("imgurl").value;

        // Get a reference to the 'products' node in your Firebase database
        const productsRef = ref(db, "products");

        // Retrieve current products to find the maximum ID
        const snapshot = await get(productsRef);
        let maxId = 0;

        // Iterate through existing products to find the maximum ID
        snapshot.forEach((childSnapshot) => {
          const productId = childSnapshot.val().id;
          maxId = Math.max(maxId, productId);
        });

        // Increment the maximum ID by 1 for the new product
        const newProductId = maxId + 1;

        // Create a new product object with the updated ID
        const newProduct = {
          id: newProductId.toString(),
          productName,
          description,
          category,
          price,
          quantity,
          imageUrl,
          id: newProductId.toString(), // Ensure the ID is a string
        };

        // Use set function to add the new product with the manually set ID
        const newProductRef = child(productsRef, newProductId.toString());
        set(newProductRef, newProduct);

        // Clear product form fields
        document.getElementById("productForm").reset();
      };

      // Attach the product form submission handler to the product form
      const productForm = document.getElementById("productForm");
      productForm.addEventListener("submit", handleProductFormSubmit);

      // //////////////////////////////////////////////////////////////////////////////////////////
      const ordersContainer = document.querySelector(".orders-content");

      // Function to retrieve orders with status pending
      const getPendingOrders = async () => {
        const ordersRef = ref(db, "orders");
        const snapshot = await get(ordersRef);
        const orders = snapshot.val();

        // Filter orders with status pending
        const pendingOrders = Object.entries(orders).filter(
          ([key, order]) => order.status === "pending"
        );

        return pendingOrders;
      };

      // Function to retrieve products
      const getProducts = async () => {
        const productsRef = ref(db, "products");
        const snapshot = await get(productsRef);
        return snapshot.val();
      };

      // Function to create order card HTML
      const createOrderCard = (orderKey, order, products) => {
        const orderCard = document.createElement("div");
        orderCard.classList.add("orders-cards");

        // Populate order card header
        const orderCardHeader = document.createElement("div");
        orderCardHeader.classList.add("order-card-header");
        orderCardHeader.innerHTML = `
      <div class="order-details">
        Order Placed: <br />${order.date}
      </div>
      <div class="order-details">Total: <br />$ ${order.totalPrice}</div>
      <div class="order-details">Order Number: <br />${orderKey}</div>
      <button class="accept-btn" data-order-key="${orderKey}">Accept</button>
      <button class="reject-btn" data-order-key="${orderKey}">Reject</button>
    `;
        orderCard.appendChild(orderCardHeader);

        // Populate order card body
        const orderCardBody = document.createElement("div");
        orderCardBody.classList.add("order-card-body");
        orderCardBody.innerHTML = `
      <h3 class="order-details">Order Status: ${order.status}</h3>
    `;

        // Populate order contents
        order.orderItems.forEach((orderItem) => {
          const productKey = orderItem.productKey;
          const product = products[productKey];

          const orderContents = document.createElement("div");
          orderContents.classList.add("order-contents");
          orderContents.innerHTML = `
        <img class="product-img order-details" src="${product.imageUrl}" />
        <div class="order-details">${product.productName}</div>
        <div class="order-details">Quantity: <br />${orderItem.quantity}</div>
        <div class="order-details">Total Price: <br />$ ${product.price}</div>
      `;

          orderCardBody.appendChild(orderContents);
        });

        orderCard.appendChild(orderCardBody);

        // Add event listeners to accept and reject buttons
        const acceptBtn = orderCard.querySelector(".accept-btn");
        const rejectBtn = orderCard.querySelector(".reject-btn");

        acceptBtn.addEventListener("click", () =>
          handleStatusChange(orderKey, "accepted")
        );
        rejectBtn.addEventListener("click", () =>
          handleStatusChange(orderKey, "rejected")
        );

        return orderCard;
      };

      // Function to handle order status change
      const handleStatusChange = (orderKey, newStatus) => {
        const orderRef = ref(db, `orders/${orderKey}/status`);
        set(orderRef, newStatus);

        // Clear existing orders and re-render pending orders
        ordersContainer.innerHTML = "";
        renderPendingOrders();
      };

      // Function to render pending orders
      const renderPendingOrders = async () => {
        const [pendingOrders, products] = await Promise.all([
          getPendingOrders(),
          getProducts(),
        ]);

        // Create and append order cards to the container
        pendingOrders.forEach(([orderKey, order]) => {
          const orderCard = createOrderCard(orderKey, order, products);
          ordersContainer.appendChild(orderCard);
        });
      };

      // Initial rendering of pending orders
      renderPendingOrders();
      // ///////////////////////////////////////////////////////////////////////////////////

      // Function to retrieve orders and products data
      async function getOrders() {
        const ordersRef = ref(db, "orders");
        const ordersSnapshot = await get(ordersRef);
        const ordersData = ordersSnapshot.val();

        const productsRef = ref(db, "products");
        const productsSnapshot = await get(productsRef);
        const productsData = productsSnapshot.val();

        displayOrders(ordersData, productsData);
      }

      // Function to dynamically create HTML elements for orders and products
      function displayOrders(orders, products) {
        const ordersContainer = document.getElementById("ordersContainer");

        for (const orderId in orders) {
          const order = orders[orderId];
          const orderCard = document.createElement("div");
          orderCard.classList.add("orders-cards");

          const orderCardHeader = document.createElement("div");
          orderCardHeader.classList.add("order-card-header");

          // Order details
          orderCardHeader.innerHTML = `
                    <div class="order-details">
                        Order Placed: <br />${order.date}
                    </div>
                    <div class="order-details">Total: <br />$ ${order.totalPrice}</div>
                    <div class="order-details">Order Number: <br />${orderId}</div>
                `;

          const orderCardBody = document.createElement("div");
          orderCardBody.classList.add("order-card-body");

          // Order status
          orderCardBody.innerHTML = `<h3 class="order-details">Order Status: ${order.status}</h3>`;

          // Order contents
          order.orderItems.forEach((orderItem) => {
            const productKey = orderItem.productKey;
            const product = products[productKey];

            const orderContents = document.createElement("div");
            orderContents.classList.add("order-contents");

            orderContents.innerHTML = `
                        <img class="product-img order-details" src="${product.imageUrl}" />
                        <div class="order-details">${product.productName}</div>
                        <div class="order-details">Quantity: <br />${orderItem.quantity}</div>
                        <div class="order-details">Total Price: <br />$ ${product.price}</div>
                    `;

            orderCardBody.appendChild(orderContents);
          });

          orderCard.appendChild(orderCardHeader);
          orderCard.appendChild(orderCardBody);

          ordersContainer.appendChild(orderCard);

          // Add a horizontal line between orders
          const hr = document.createElement("hr");
          ordersContainer.appendChild(hr);
        }
      }

      // Call the function to retrieve and display orders
      getOrders();
    </script>
  </body>
</html>
