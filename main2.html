<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eCommerce Shop</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="main.css" />
    <link rel="icon" type="image/x-icon" href="images/logo.svg" />
  </head>
  <body>
    <nav class="main-nav">
      <img src="images/logo.svg" alt="logo" class="main-page" />
      <img src="images/icons8-cart-96.png" alt="cart" id="cart-logo" />
    </nav>
    <div class="cart">
      <div class="relevant">
        <nav>
          <p class="cart-title">Shopping Bag (<span id="count">5</span>)</p>
          <img
            src="images/right-arrow.png"
            alt="back arrow"
            class="backArrow"
          />
        </nav>
        <hr style="width: 90%; color: #f1f2f3" />
        <div class="cart-items-container">
          <!-- cart items goes here dynamically -->
        </div>
        <div class="cart-footer">
          <div class="cartFooter-firstRow">
            <p class="main-total">Total: $109.95</p>
            <img
              src="images/delete (2).png"
              alt="deleta all"
              class="rubbish-icon"
            />
          </div>
          <div class="cartFooter-btnsContainer">
            <button class="view-cart cartFooter-btn">View cart</button>
            <button class="check-out cartFooter-btn">Checkout</button>
          </div>
        </div>
      </div>
    </div>
    <div class="hero">
      <div class="hero_header_container">
        <span id="welcome">Hello User</span>
        <p class="trend">new trend</p>
        <h1 class="hero_header">
          automn sale stylish <span class="womens-word">womens</span>
        </h1>
        <p class="discover">discover more</p>
        <br />
        <a id="order" style="cursor: pointer" "
          >Make New Order</a
        ><br />
        <a id="profile" style="cursor: pointer" onclick="redirectToProfile()"
          >Your Profile</a
        ><br />
        <a id="signout" style="cursor: pointer">Signout</a>
      </div>
      <div class="hero_image">
        <img src="images/woman_hero.png" alt="hero image" />
      </div>
    </div>
    <div class="products-container" id="main-container">
      <!-- products goes here dynamically -->
    </div>
    <div class="product-description" style="display: none">
      <!-- <div class="desc-image-container">
                <img src="images/51kzIp0mUnL._AC_SY741_.jpg" alt="product image">
            </div>
            <div class="info-container">
                <h1 class="desc-product-title">Men's Casual Premium Slim Fit T-Shirts</h1>
                <p class="desc-product-price">$ 22.2</p>
                <p class="desc-product-description">Lorem ipsum dolor sit amet consectetur adipisicing elit. Porro nisi illo neque temporibus sequi? Sunt, impedit aperiam deserunt facilis qui praesentium et modi velit tempora aliquam repudiandae suscipit, ab omnis ullam laborum veritatis recusandae sapiente consectetur cupiditate fugit, commodi dolore.</p>
                <button class="desc-product-AddButton">Add to cart</button>
            </div> -->
    </div>
    <footer>
      <p>Copyright&copy; Ecommerce shop 2023. All rights reserved</p>
    </footer>

    <script src="main.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCYSCp9ciAbTeM_DYOpOlwRqH33hEfV5pI",
        authDomain: "ecommerce-iti-5e820.firebaseapp.com",
        databaseURL:
          "https://ecommerce-iti-5e820-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "ecommerce-iti-5e820",
        storageBucket: "ecommerce-iti-5e820.appspot.com",
        messagingSenderId: "646973727955",
        appId: "1:646973727955:web:871efec421dc8355bf6026",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      import {
        getDatabase,
        ref,
        child,
        get,
        set,
        update,
        remove,
        push,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      const db = getDatabase();
      // ///////////////////////////////////////////////////////////////////////////
      let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
      let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));


      if (UserInfo) {
        console.log(UserInfo);
      } else {
        console.log(
          "User-Info is not available or is not a valid JSON string."
        );
      }
      let welcome = document.getElementById("welcome");
      welcome.innerHTML = `Welcome ${UserInfo.firstname}`;

      let signoutbtn = document.getElementById("signout");
      let signout = () => {
        sessionStorage.removeItem("user-creds");
        sessionStorage.removeItem("user-info");
        window.location.href = "main.html";
      };
      signoutbtn.addEventListener("click", signout);
      // ///////////////////////////////////////////////////////////////////////////////////
     
  // Function to fetch products
  function fetchProducts() {
    return new Promise((resolve) => {
      const productsRef = ref(db, "products");
      onValue(productsRef, (snapshot) => {
        const products = snapshot.val();
        resolve(products);
      });
    });
  }

// Function to calculate total price of an order
function calculateTotalPrice(orderItems, products) {
  let totalPrice = 0;

  orderItems.forEach((item) => {
    const product = products[item.productKey];
    if (product) {
      console.log("Product Key:", item.productKey);
      console.log("Product Price:", product.price);
      console.log("Ordered Quantity:", item.quantity);
      totalPrice += parseFloat(product.price) * item.quantity;
    }
  });

  console.log("Total Price:", totalPrice.toFixed(2));

  return totalPrice.toFixed(2);
}

  // Function to submit a new order
  async function submitNewOrder() {
    // Get the currently logged-in user ID from session storage
    let userCreds = JSON.parse(sessionStorage.getItem("user-creds"));
    if (!userCreds) {
      console.error("User not logged in");
      return;
    }

    // Fetch the products from the database
    const products = await fetchProducts();

    // Create a new order object
    const newOrder = {
      uid: userCreds.uid,
      status: "pending",
      date: new Date().toLocaleDateString(),
      totalPrice: 0, 
      orderItems: [{
          productKey: "-NmSwGObLrBujbxfZFkV", 
          quantity: 2,
        },
        {
          productKey: "-NmSwOOv5duheI0rId-H", 
          quantity: 1,
        },
      ],
    };

    // Calculate the total price
    newOrder.totalPrice = calculateTotalPrice(newOrder.orderItems, products);

    // Save the new order to the database
    const newOrderRef = push(ref(db, "orders"));
    set(newOrderRef, newOrder);

    console.log("New order submitted:", newOrder);
  }
  document.getElementById('order').addEventListener('click', function () {
    submitNewOrder();
      });


      // /////////////////////////////////////////////////////////////////////////////
      document.addEventListener("DOMContentLoaded", function () {
    // Get user role from sessionStorage
    let userRole = UserInfo.role;

    // Get the profile link element
    const profileLink = document.getElementById("profile");

    // Add click event listener to the profile link
    profileLink.addEventListener("click", function () {
      // Redirect based on user role
      if (userRole === "customer") {
        window.location.href = "/Userprofile/customerProfile.html";
      } else if (userRole === "admin") {
        window.location.href = "/Adminprofile/AdminProfile.html";
      }
    });
  });
    </script>
  </body>
</html>
